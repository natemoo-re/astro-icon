---
import type { AstroIconCollection, AstroIconOptions } from "virtual:astro-icon";
import { getIconData, iconToSVG } from "@iconify/utils";
import { cache } from "./cache.js";

export interface IconProps {
  name: import("astro-icon").Icon;
  title?: string;
  size?: number;
  width?: number;
  height?: number;
}
export interface MetaProps {
  icons: AstroIconCollection;
  config?: AstroIconOptions;
}

interface Props extends IconProps, MetaProps {}

const req = Astro.request;
const { icons, config, name = "", title, ...props } = Astro.props as Props;
const map = cache.get(req) ?? new Map();
const i = map.get(name) ?? 0;
map.set(name, i + 1);
cache.set(req, map);

const includeSymbol = i === 0;

let [setName, iconName] = name.split(":");

if (iconName === undefined) {
  iconName = setName;
  setName = undefined;
  if (iconName in icons["local"].icons) {
    setName = "local";
  } else {
    for (const [prefix, collection] of Object.entries(icons)) {
      if (setName in collection.icons) {
        setName = prefix;
        break;
      }
    }
  }
}

if (setName === undefined) {
  const err = new Error(`Unable to find a set for the "${iconName}" icon!`);
  if (import.meta.env.DEV) {
    const include = config?.include;
    if (include) {
      const sets = Object.keys(include);
      if (sets.length === 1) {
        err.hint = `The "${sets[0]}" set does not include a "${iconName}" icon.\n\nDid you forget to include the icon or make a typo?`;
      } else {
        err.hint = `None of your icon sets ("${sets.join(
          `" | "`
        )}") include a "${iconName}" icon.\n\nDid you forget to include this icon in your configuration?`;
      }
    }
  }
  throw err;
}

const collection = icons[setName];

if (!collection) {
  const err = new Error(`Unable to locate the "${setName}" icon set!`);

  const include = config?.include;
  if (import.meta.env.DEV) {
    if (include) {
      if (setName in include) {
        err.hint = `The "${setName}" set is included but it doesn't seem to be installed.\n\nDo you need to install the "${setName}" set?`;
      } else {
        err.hint = `It looks like the "${setName}" set is not included in your configuration.\n\nDo you need to add the "${setName}" set?`;
      }
    } else {
      err.hint = `The "${setName}" set doesn't seem to be installed.\n\nDo you need to install the "${setName}" set?`;
    }
  }

  throw err;
}

const iconData = getIconData(collection, iconName ?? setName);
if (!iconData) {
  const err = new Error(`Unable to locate "${name}" icon!`);

  if (import.meta.env.DEV) {
    const include = config?.include;
    if (include && setName in include && include[setName][0] !== "*") {
      err.hint = `The "${setName}" set is not configured to include an icon named "${iconName}".\n\nDo you need to add it to your configuration?`;
    } else {
      err.hint = `The "${setName}" set does not include an icon named "${iconName}".\n\nIs this a typo? Is the "@iconify/json" dependency out of date?`;
    }
  }

  throw err;
}

const id = `ai:${collection.prefix}:${iconName ?? setName}`;

if (props.size) {
  props.width = props.size;
  props.height = props.size;
  delete props.size;
}
const renderData = iconToSVG(iconData);
const normalizedProps = { ...renderData.attributes, ...props };
const normalizedBody = renderData.body;
---

<svg {...normalizedProps} data-icon={name}>
  {title && <title>{title}</title>}
  {includeSymbol && <symbol id={id} set:html={normalizedBody} />}
  <use xlink:href={`#${id}`}></use>
</svg>
