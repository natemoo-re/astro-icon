---
import icons, { config } from "virtual:astro-icon";
import { getIconData, iconToSVG } from "@iconify/utils";
import { cache } from "./cache";
// @ts-expect-error - Types are generated by the integration
import type { Icon } from "astro-icon";
import type { HTMLAttributes } from "astro/types";

interface Props extends HTMLAttributes<"svg"> {
  name: Icon;
  title?: string;
  size?: number;
  width?: number;
  height?: number;
}

const req = Astro.request;
const { name = "", title, ...props } = Astro.props;
const map = cache.get(req) ?? new Map();
const i = map.get(name) ?? 0;
map.set(name, i + 1);
cache.set(req, map);

const includeSymbol = i === 0;

let [setName, iconName] = name.split(":");

const collection = iconName ? icons[setName] : icons["local"];

if (!collection) {
  const err = new Error(`Unable to locate "${name}" icon!`);

  if (import.meta.env.DEV) {
    const { include = {} } = config;
    const sets = Object.keys(include);
    if (setName && iconName) {
      if (!sets.includes(setName)) {
        err.hint = `It looks like the "${setName}" set is not included in your configuration.\n\nDo you need to add the "${setName}" set?`;
      }
    } else {
      if (sets.length === 1) {
        err.hint = `The "${sets[0]}" set does not include a "${setName}" icon.\n\nDid you forget to include the icon or make a typo?`;
      } else {
        err.hint = `None of your icon sets ("${sets.join(
          `" | "`
        )}") include a "${setName}" icon.\n\nDid you forget to include this icon in your configuration?`;
      }
    }
  }

  throw err;
}

const iconData = getIconData(collection, iconName ?? setName);
if (!iconData) {
  const err = new Error(`Unable to locate "${name}" icon!`);

  if (import.meta.env.DEV) {
    const { include = {} } = config;
    const [maybeStar] = include[setName];
    if (maybeStar === "*") {
      err.hint = `The "${setName}" set does not include an icon named "${iconName}".\n\nIs this a typo? Is the "@iconify/json" dependency out of date?`;
    } else {
      err.hint = `The "${setName}" set is not configured to include an icon named "${iconName}".\n\nDo you need to add it to your configuration?`;
    }
  }

  throw err;
}

const id = `ai:${collection.prefix}:${iconName ?? setName}`;

if (props.size) {
  props.width = props.size;
  props.height = props.size;
  delete props.size;
}
const renderData = iconToSVG(iconData);
const attribute = config.attribute || "astro-icon";
const normalizedProps = {
  ...renderData.attributes,
  ...props,
  [attribute]: name,
};
const normalizedBody = renderData.body;
---

<svg {...normalizedProps}>
  {title && <title>{title}</title>}
  {includeSymbol && <symbol id={id} set:html={normalizedBody} />}
  <use xlink:href={`#${id}`}></use>
</svg>
